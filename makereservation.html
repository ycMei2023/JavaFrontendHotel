<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <title>Java Hotel YC</title>
</head>
<body>
    <div id="nav-placeholder">
    </div>

    <div class="container">
    <div class="row">
    <div class="col-md-8 col-sm-12">

    <div class="input-group">
        <span class="input-group-text" >Voornaam</span>
        <input id="firstName" type="text" class="form-control" placeholder="Jan" aria-label="guest's first name" aria-describedby="basic-addon1">
    </div>

    <div class="input-group">
        <span class="input-group-text" >Achternaam</span>
        <input id="lastName" type="text" class="form-control" placeholder="Smit" aria-label="guest's last name" aria-describedby="basic-addon2">
    </div>

      <div class="input-group">
        <span class="input-group-text" id="basic-addon2">Telefoonnummer</span>
        <input type="number" class="form-control" placeholder="31 06 4444444" aria-label="guest's phone number" aria-describedby="basic-addon3">
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="breakfastCheck" onclick="calcPrice()">
        <label class="form-check-label" for="breakfastCheck">
          Ontbijt toevoegen (€15 per persoon per nacht)
        </label>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="" id="businessCheck">
        <label class="form-check-label" for="businessCheck">
          Zakelijk verblijf
        </label>
      </div>
      <br>

    </div>

    <div class="col-md-4 col-sm-12">
      <table class="table table-borderless table-sm" id="dynamicPrice"></table>
    </div>

    </div>

    <div class="row">
      <div class="col">
        <button type="button" onclick="reserveR()" class="btn btn-primary"> Kamer reserveren </button>
      </div>
    </div>

    </div>

    <div id="footer-placeholder">
    </div>
  
  <!-- Modal -->
  <!-- The model currently serves no purpose. Leaving the code in, in case we need to add payment or confirmation buttons later 
          If implementing again: beware that the button no longer calls the modal! This needs to be re-created.
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Reservation placed for guest 
        </div>
        <div class="modal-footer">
          <button type="button" onclick="bookPayAtHotelR(reservationid)" class="btn btn-secondary" data-bs-dismiss="modal">Pay at hotel</button>
          <button type="button" onclick="bookR(reservationid)" class="btn btn-primary" data-bs-dismiss="modal">Pay now</button>
        </div>
      </div>
    </div>
  </div> -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>

      // NAV-bar
      $(function(){
        $("#nav-placeholder").load("navbar.html");
      });
      $(function(){
        $("#footer-placeholder").load("footer.html");
      });      

      // Collect previously passed parameters - used in other functions below
      var urlParams = new URL(window.location).searchParams;
      var checkInDate = urlParams.get("checkInDate");
      var checkOutDate = urlParams.get("checkOutDate");
      var numGuests = urlParams.get("adults");
      var roomId = urlParams.get("roomId");

      var reservationid;
      var totalPrice = 0;

      async function calcPrice(){
        // Fetch room object based on ID for the current price
        var response = await fetch(`http://localhost:8080/room/${roomId}`);
        var room = await response.json();
        
        // Make strings into date objects to cacluate the days difference
        var dateOut = new Date(checkOutDate);
        var dateIn = new Date(checkInDate);
        var nights = (dateOut - dateIn) / 1000 / 3600 / 24;

        // Calculate relevant prices for the overview
        var roomPrice = nights * room.price;
        var touristTax = numGuests * nights * 3;
        totalPrice = roomPrice + touristTax;
        
        // If breakfast is checked, add it to the total price
        // Creates a flag too, for later use
        var breakfastFlag = "nee";
        var breakfastPrice = 0;

        if (document.getElementById("breakfastCheck").checked){
          breakfastPrice = numGuests * 15 * nights;
          breakfastFlag = "ja";
          totalPrice += breakfastPrice;
        }

        // Put current price in the div with id "dynamicPrice"
        var dynamicPriceHTML = `
            <tr><td> Kamertype: </td> <td>${room.type}</td></tr>
            <tr><td> Gasten: </td> <td>${numGuests}</td></tr>
            <tr><td> Nachten: </td> <td>${nights}</td></tr>
            <tr><td> Van: </td> <td>${checkInDate}</td></tr> 
            <tr><td> Tot: </td> <td>${checkOutDate}</td></tr>
            <tr><td> Subtotaal: </td> <td>€ ${roomPrice}</td></tr>
            <tr><td> Ontbijt: </td> <td>${breakfastFlag}</td></tr>
            <tr><td> Ontbijt meerprijs: </td> <td>${breakfastPrice}</td></tr>
            <tr><td> Touristenbelasting: </td> <td>€ ${touristTax}</td></tr>
            <tr><td> Totaal: </td> <td>€ ${totalPrice}</td></tr>`
        document.getElementById("dynamicPrice").innerHTML = dynamicPriceHTML;

      }

      function reserveR(){

        var reservationDto = {};

        // Room data
        reservationDto.amountPeople = numGuests;
        reservationDto.beginDate = checkInDate;
        reservationDto.endDate = checkOutDate;
        reservationDto.breakfast = document.getElementById("breakfastCheck").checked;
        reservationDto.business = document.getElementById("businessCheck").checked;
        reservationDto.roomId = roomId;

        // Guest data
        reservationDto.firstName = document.getElementById("firstName").value;
        reservationDto.lastName = document.getElementById("lastName").value;

        // Price
        reservationDto.price = totalPrice;

        var theJSON = JSON.stringify(reservationDto);
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function(){
          if(this.readyState == 4 && this.status == 200){
            reservationId = JSON.parse(xhr.responseText);
            bookingComplete(reservationId);
          }
        }
        xhr.open("POST", "http://localhost:8080/addLinkedReservation", true)
        xhr.setRequestHeader("Content-Type","application/json");
        xhr.send(theJSON);

      }

      function bookingComplete(reservationId){
        window.location.href = "/reservationCompleted.html?reservationId="+reservationId;
      }

      // Function call when first loading the page
      calcPrice();



        /* Currently all reservations need manual approval by admin (in reservations CRUD). Leaving these booking-status functions in case we need them later.

        function bookR(reservationid){
            paymentStatus = true;

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function(){
                if(this.readyState == 4){
                    console.log("approve succesful")
                }
            }
            xhr.open("PUT", "http://localhost:8080/approvereservation/"+paymentStatus, true)
            xhr.setRequestHeader("Content-Type","application/json");
            xhr.send(reservationid);
        }

        function bookPayAtHotelR(reservationid){
            paymentStatus = false;

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function(){
                if(this.readyState == 4){
                    console.log("approve succesful")
                }
            }
            xhr.open("PUT", "http://localhost:8080/approvereservation/"+paymentStatus, true)
            xhr.setRequestHeader("Content-Type","application/json");
            xhr.send(reservationid);
        }
        */



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>