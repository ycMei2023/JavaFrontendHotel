<!DOCTYPE html>
<html lang="en">

<script>
    if(sessionStorage.getItem('userType') == 1){
    } else {
        window.location.href='index.html';
    }

</script>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>

<body>

    <!-- NAVBAR -->
    <div id="nav-placeholder">

    </div>

    <!-- BUTTONS -->
    <div class="container my-4">
        <div class="row">
            <div class="col-12">
                <h1>Room Dashboard</h1>
            </div>
        </div>

        <div class="row my-2">
            <div class="col-12 col-md-4">
                <label for="roomType" class="form-label">Kamertype</label>
                <select id="roomType" class="form-select" aria-label="Default select example">
                    <option value="single">Single</option>
                    <option value="double">Double</option>
                    <option value="family">Family</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label for="roomPrice" class="form-label">Kamerprijs</label>
                <input id="roomPrice" class="form-control" type="number" placeholder="00.00">
            </div>
            <div class="col-12 col-md-4">
                <label for="roomNo" class="form-label">Kamernummer</label>
                <input id="roomNo" class="form-control" type="number" placeholder="000">
            </div>

        </div>

        <div class="row my-3">
            <div class="col">

                <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#save-modal" onclick="prepareAddRoom()" >
                    <i class="fa fa-plus me-1"></i>
                    Kamer toevoegen
                </button>
                <button type="button" class="btn btn-primary" onclick="showRooms()">
                    <i class="fa fa-eye me-1"></i>
                    Update Overzicht
                </button>

            </div>
        </div>

        <div class="row my-5">
            <div class="col" id="allRoomsTable">
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="ttt" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <!--<img src="..." class="rounded me-2" alt="...">-->
                <strong class="me-auto">Systeem</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div id="toasty" class="toast-body">
                Hello, world! This is a toast message.
            </div>
        </div>
    </div>

    <div id="footer-placeholder">

    </div>

    <div class="modal" tabindex="-1" id="save-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kamer opslaan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row my-2">
                        <div class="col-12 mb-2">
                            <label for="save-roomtype" class="form-label">Kamertype</label>
                            <select id="save-roomtype" class="form-select" aria-label="Default select example">
                                <option value="single">Single</option>
                                <option value="double">Double</option>
                                <option value="family">Family</option>
                            </select>
                        </div>
                        <div class="col-12 mb-2">
                            <label for="save-roomprice" class="form-label">Kamerprijs</label>
                            <input id="save-roomprice" class="form-control" type="number" placeholder="00.00">
                        </div>
                        <div class="col-12">
                            <label for="save-roomnumber" class="form-label">Kamernummer</label>
                            <input id="save-roomnumber" class="form-control" type="number" placeholder="000">
                        </div>
                    </div>
            
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoom()">
                        <i class="fa fa-disk me-1"></i>
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <!------------->

    <!-- BOOTSTRAP -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

    <!-- FUNCTIONS -->
    <script>
        $(function () {
            $("#nav-placeholder").load("navbar.html");
        });
        $(function () {
            $("#footer-placeholder").load("footer.html");
        });

        let selectedRoomId = 0;

        function prepareAddRoom() {
            this.selectedRoomId = 0;
            document.getElementById("save-roomtype").value = '';
            document.getElementById("save-roomprice").value = '';
            document.getElementById("save-roomnumber").value = '';
        }

        function prepareUpdateRoom(id) {
            this.selectedRoomId = id;

            fetch('http://localhost:8080/room/' + id)
                .then(response => response.json())
                .then(room => {
                    document.getElementById("save-roomtype").value = room.type;
                    document.getElementById("save-roomprice").value = room.price;
                    document.getElementById("save-roomnumber").value = room.roomNo;
                })
        }

        function saveRoom() {
            var saveRoom = {}; //create an empty object
            saveRoom.type = document.getElementById("save-roomtype").value;
            saveRoom.price = document.getElementById("save-roomprice").value;
            saveRoom.roomNo = document.getElementById("save-roomnumber").value;

            if (this.selectedRoomId > 0) {
                var newRoomJSON = JSON.stringify(saveRoom);

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        toastFeedback("Kamer succesvol aangepast");
                        showRooms();
                        $('#save-modal').modal('hide');
                    }
                }
                xhr.open("PUT", "http://localhost:8080/updateRoom/" + this.selectedRoomId, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(newRoomJSON);
            } else {
                var newRoomJSON = JSON.stringify(saveRoom);

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        toastFeedback("Kamer succesvol toegevoegd");
                        showRooms();
                        $('#save-modal').modal('hide');
                    }
                }
                xhr.open("POST", "http://localhost:8080/addRoom", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(newRoomJSON);                
            }
        }

        function showRooms() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4) {
                    var allRooms = JSON.parse(this.responseText);
                    var finalString = `
                        <table class="table table-striped"> 
                            <thead>
                                <tr>
                                    <th> ID </th>
                                    <th> Type </th>
                                    <th> Price </th>
                                    <th> Reserved </th>
                                    <th> Room No </th>
                                    <th> Acties </th>
                                </tr>
                            </thead>
                            <tbody>
                        `;

                    for (var x = 0; x < allRooms.length; x++) {
                        // console.log(allRooms[x]);
                        finalString += `
                                <tr>
                                    <td>${allRooms[x].id}</td>
                                    <td>${allRooms[x].type}</td>
                                    <td>${allRooms[x].price}</td>
                                    <td>${allRooms[x].reserved}</td>
                                    <td>${allRooms[x].roomNo}</td>
                                    <td class="text-end">
                                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#save-modal" onclick=prepareUpdateRoom(${allRooms[x].id})>
                                            <i class="fa fa-edit me-1"></i>
                                            Update
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick=deleteRoom(${allRooms[x].id})>
                                            <i class="fa fa-trash me-1"></i>
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                        `;
                    }
                    finalString += `
                            </tbody>
                        </table>
                    `;

                    document.getElementById("allRoomsTable").innerHTML = finalString;
                }
            }
            xhr.open("GET", "http://localhost:8080/allRooms", true);
            xhr.send();
        }

        function deleteRoom(id) {
            var temp_id = id;

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4) {
                    toastFeedback("Kamer verwijderd");
                    showRooms();
                }
            }
            xhr.open("DELETE", "http://localhost:8080/deleteRoom", true);
            xhr.send(temp_id);
        }

        // Toast functionality -- use instead of console.log als feedback
        function toastFeedback(feedback) {
            var toastLiveExample = document.getElementById("ttt");

            //Feedback text in html body of toast
            document.getElementById("toasty").innerHTML = feedback;

            toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
            toastBootstrap.show();
        }

        showRooms(); //show room list by default
    </script>
</body>

</html>